<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.omise.co/omise.js" onload="initializeCheckout()"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800">Checkout</h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Shipping Information</h2>
                <form id="shipping-form">
                    <div class="mb-4">
                        <label for="name" class="block text-gray-700 font-bold mb-2">Full Name</label>
                        <input type="text" id="name" name="name" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-bold mb-2">Email</label>
                        <input type="email" id="email" name="email" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-gray-700 font-bold mb-2">Phone Number</label>
                        <input type="tel" id="phone" name="phone" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="address" class="block text-gray-700 font-bold mb-2">Address</label>
                        <input type="text" id="address" name="address" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="city" class="block text-gray-700 font-bold mb-2">City</label>
                        <input type="text" id="city" name="city" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="zip" class="block text-gray-700 font-bold mb-2">ZIP Code</label>
                        <input type="text" id="zip" name="zip" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                </form>
            </div>

            <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Payment</h2>
                <div id="payment-methods">
                    <form id="checkout-form">
                        <div id="credit-card-form" class="mb-4"></div>
                        <button type="submit" id="credit-card-button" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">Pay with Credit Card</button>
                    </form>
                    <div class="mt-4">
                        <button id="qr-code-button" class="w-full bg-gray-800 text-white py-2 rounded-md hover:bg-gray-900">Pay with QR Code</button>
                    </div>
                    <div class="mt-4">
                        <button id="mobile-banking-button" class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600">Pay with Mobile Banking (SCB)</button>
                    </div>
                    <div id="qr-code-container" class="hidden mt-4"></div>
                </div>
                <div class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Order Summary</h3>
                    <div id="order-summary" class="bg-white p-4 rounded-md shadow-md">
                        </div>
                    <div class="flex justify-between font-bold mt-4">
                        <span>Total</span>
                        <span id="order-total">à¸¿0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function initializeCheckout() {
            try {
                console.log('Omise.js loaded. Initializing checkout script.');

                Omise.setPublicKey('pkey_test_64vym5brctfmko3thct');

                const orderSummary = document.getElementById('order-summary');
                const orderTotal = document.getElementById('order-total');
                const cart = JSON.parse(localStorage.getItem('cart'));
                const checkoutForm = document.getElementById('checkout-form');
                const creditCardForm = document.getElementById('credit-card-form');
                const qrCodeButton = document.getElementById('qr-code-button');
                const mobileBankingButton = document.getElementById('mobile-banking-button');
                const creditCardButton = document.getElementById('credit-card-button');
                const qrCodeContainer = document.getElementById('qr-code-container');

                let totalAmount = 0;

                if (cart && cart.length > 0) {
                    orderSummary.innerHTML = '';
                    cart.forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex justify-between mb-2';
                        itemElement.innerHTML = `
                            <span>${item.name} (x${item.quantity})</span>
                            <span>${new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(item.price / 100 * item.quantity)}</span>
                        `;
                        orderSummary.appendChild(itemElement);
                        totalAmount += item.price * item.quantity;
                    });
                    orderTotal.textContent = new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(totalAmount / 100);
                } else {
                    orderSummary.innerHTML = '<p>Your cart is empty.</p>';
                    creditCardButton.disabled = true;
                    qrCodeButton.disabled = true;
                    mobileBankingButton.disabled = true;
                }

                creditCardForm.innerHTML = `
                    <div class="form-row">
                        <div id="card-element" class="p-3 border rounded-md bg-white"></div>
                        <div id="card-errors" role="alert" class="text-red-500 text-sm mt-2"></div>
                    </div>
                `;
                
                // This will now execute without error because Omise.js is guaranteed to be loaded.
                Omise.card.configure({
                    element: document.getElementById('card-element'),
                });
                Omise.card.mount();

                const handleCreditCardPayment = (token) => {
                    creditCardButton.disabled = true;
                    creditCardButton.textContent = 'Processing...';

                    fetch('/api/charge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token: token,
                            amount: totalAmount,
                            currency: 'thb',
                            items: cart
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'successful' || data.status === 'pending') {
                            alert('Payment successful!');
                            localStorage.removeItem('cart');
                            window.location.href = '/';
                        } else {
                            throw new Error(data.message || 'Payment failed.');
                        }
                    })
                    .catch((error) => {
                        console.error('Credit Card Error:', error);
                        alert(`Payment failed: ${error.message}`);
                        creditCardButton.disabled = false;
                        creditCardButton.textContent = 'Pay with Credit Card';
                    });
                };

                checkoutForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    Omise.createToken('card', checkoutForm, function(statusCode, response) {
                        if (statusCode === 200) {
                            handleCreditCardPayment(response.id);
                        } else {
                            const errorContainer = document.getElementById('card-errors');
                            errorContainer.textContent = response.message || 'An unexpected error occurred.';
                        }
                    });
                });

                qrCodeButton.addEventListener('click', async () => {
                    qrCodeButton.disabled = true;
                    qrCodeButton.textContent = 'Generating QR Code...';
                    
                    try {
                        const sourceResponse = await fetch('/api/create-source', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'promptpay',
                                amount: totalAmount,
                                currency: 'thb'
                            })
                        });

                        if (!sourceResponse.ok) {
                            const errorData = await sourceResponse.json();
                            throw new Error(errorData.message);
                        }

                        const sourceData = await sourceResponse.json();
                        qrCodeContainer.innerHTML = `<div class="text-center">
                            <p class="mb-2">Scan the QR code to pay.</p>
                            <img src="${sourceData.scannable_code.image.download_uri}" alt="QR Code" class="mx-auto border">
                            <p class="mt-2 text-sm text-gray-500">Waiting for payment...</p>
                        </div>`;
                        qrCodeContainer.classList.remove('hidden');
                        qrCodeButton.textContent = 'QR Code Generated';

                    } catch (error) {
                        console.error('QR Code Error:', error);
                        alert('Could not generate QR Code: ' + error.message);
                        qrCodeButton.disabled = false;
                        qrCodeButton.textContent = 'Pay with QR Code';
                    }
                });
                
                mobileBankingButton.addEventListener('click', async () => {
                    mobileBankingButton.disabled = true;
                    mobileBankingButton.textContent = 'Processing...';

                    try {
                        const sourceResponse = await fetch('/api/create-mobile-banking-source', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'mobile_banking_scb',
                                amount: totalAmount,
                                currency: 'thb',
                                return_uri: window.location.origin + '/payment-success'
                            })
                        });

                        if (!sourceResponse.ok) {
                             const errorData = await sourceResponse.json();
                            throw new Error(errorData.message);
                        }

                        const sourceData = await sourceResponse.json();
                        if (sourceData.authorize_uri) {
                            window.location.href = sourceData.authorize_uri;
                        } else {
                            throw new Error('Could not get authorization URL.');
                        }

                    } catch (error) {
                        console.error('Mobile Banking Error:', error);
                        alert('Could not initiate payment: ' + error.message);
                        mobileBankingButton.disabled = false;
                        mobileBankingButton.textContent = 'Pay with Mobile Banking (SCB)';
                    }
                });

            } catch (error) {
                console.error('A critical error occurred in the checkout script:', error);
                alert('An unexpected error occurred. Please try again later.');
            }
        }
    </script>

</body>
</html>